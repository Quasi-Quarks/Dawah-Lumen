<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dawah Luminance</title>

  <!-- PWA / iOS-safe viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <meta name="apple-mobile-web-app-title" content="Dawah Luminance">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#001d4b">

  <!-- Icons & Manifest (GitHub Pages project path) -->
  <link rel="apple-touch-icon" sizes="192x192" href="/Dawah-Lumen/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/Dawah-Lumen/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/Dawah-Lumen/icons/icon-512.png">
  <link rel="manifest" href="/Dawah-Lumen/manifest.webmanifest">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">
</head>
<body id="body">

  <!-- App bar -->
  <div class="appbar">
    <h1>Dawah Luminance 💡 v55</h1>
    <div class="topbar" role="navigation" aria-label="Main controls">
      <button id="menuOpen" class="menu-btn" type="button" aria-label="Open menu">☰</button>
      <div class="userBadge" id="userBadge" hidden>
        <img id="avatar" class="avatar" alt="avatar" src="">
        <p id="badgeName"></p>
      </div>
    </div>
  </div>

  <!-- Profiles row -->
  <div id="top_section">
    <div id="profile_view" aria-label="Profiles"></div>
  </div>

  <!-- Messages -->
  <main>
    <div id="messages" aria-live="polite"></div>
  </main>

  <!-- Composer (fixed bottom) -->
  <div class="formsend" id="composer">
    <form id="form" autocomplete="off">
      <input id="chat" type="text" placeholder="Messaging disabled" maxlength="500" disabled aria-label="Type message">
      <button id="sendBtn" type="submit" disabled aria-label="Send"></button>
    </form>
  </div>

  <!-- Menu overlay -->
  <div id="menu" class="menu" aria-hidden="true">
    <div class="menu__card" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
      <div class="menu__row" style="justify-content:space-between;">
        <strong id="menuTitle">Menu</strong>
        <button id="menuClose" class="menu__btn menu__close" type="button" aria-label="Close menu">✕</button>
      </div>
      <p style="margin:.25rem 0 .6rem;opacity:.9">Add to Home Screen and allow push notifications.</p>

      <div><strong>Login</strong></div>
      <div class="menu__row">
        <input id="loginUser" value="Guest" placeholder='Username e.g. "Guest"' autocomplete="off">
        <input id="loginCode" value="12345" placeholder='Code e.g. "12345"' autocomplete="off">
        <button id="loginBtn" class="menu__btn" type="button" style="width:max-content">Login</button>
      </div>

      <div><strong>Notifications</strong></div>
      <div class="menu__row">
        <button id="enablePush" class="menu__btn" type="button" style="width:max-content">Enable notifications</button>
      </div>
      <div id="permStatus" class="tiny" style="margin-top:.25rem;"></div>
    </div>
  </div>

  <script type="module">
    /* Firebase (CDN) */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDOZU1AJi7ONWlKYgiIJXWoj7X8VAoZ9rM",
      authDomain: "dawah-lumen-v1.firebaseapp.com",
      projectId: "dawah-lumen-v1",
      storageBucket: "dawah-lumen-v1.firebasestorage.app",
      messagingSenderId: "796313906776",
      appId: "1:796313906776:web:045884e106cf4ee5f2e42d",
      measurementId: "G-660003ER5V"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* Elements */
    const messagesEl = document.getElementById('messages');
    const form       = document.getElementById('form');
    const chatInput  = document.getElementById('chat');
    const sendBtn    = document.getElementById('sendBtn');
    const composer   = document.getElementById('composer');

    const userBadge = document.getElementById('userBadge');
    const avatarEl  = document.getElementById('avatar');
    const badgeName = document.getElementById('badgeName');

    const menuEl     = document.getElementById('menu');
    const menuOpen   = document.getElementById('menuOpen');
    const menuClose  = document.getElementById('menuClose');
    const loginUser  = document.getElementById('loginUser');
    const loginCode  = document.getElementById('loginCode');
    const loginBtn   = document.getElementById('loginBtn');

    const enablePushBtn = document.getElementById('enablePush');
    const permStatus    = document.getElementById('permStatus');

    const profileview   = document.getElementById('profile_view');

    /* Profiles */
    const profiles_users = [
      ["Guest", "guest.PNG", "12345"],
      ["Abu", "abu.PNG", "4829Q"],
      ["Chaos", "chaos.PNG", "1937A"],
      ["Cowboy", "cowboy.PNG", "5921X"],
      ["Da Kid", "dakid.jpg", "7704B"],
      ["Draco", "draco.PNG", "8382Z"],
      ["Empress", "empress.jpg", "2229C"],
      ["Love", "farah2.PNG", "9031D"],
      ["Abdul Jaleel", "gmoney.webp", "5167E"],
      ["Hakeem", "hakeem.avif", "1473F"],
      ["Lut", "lut.PNG", "3345G"],
      ["Mr Khan", "mrkhan.PNG", "4402H"],
      ["Premier", "premeir.jpg", "6619J"],
      ["Sword of Allah", "swordofallah.jpg", "7832K"],
      ["The Lion", "thelion.PNG", "1984L"],
      ["Whiskey Blues", "whiskeybluews.PNG", "9203M"],
      ["safwan", "safwan.PNG", "9204M"],
      ["Salaam Alaykum", "salaamalaykum.PNG", "9205M"],
      ["Abdul", "picture.png", "picture.png"],
      ["Ceeszafly", "ceezafly.PNG", "9205E"],
      ["Khalifa", "khalifa.PNG", "9205A"],
      ["The Orthodox", "theorthodox.PNG", "9205Y"],
      ["Musa⚔️Khan", "musakhan.PNG", "9205Y"],
      ["Libra", "libra.PNG", "9205T"],
      ["True Knowledge", "ilyes.jpg", "920TT"],
      ["ILYES", "", "920TT"],
    ];
    const avatarByName = new Map(profiles_users.map(([n, img]) => [n, img]));

    /* Profiles preview (simple, centered by CSS) */
    const profiles_views = [
      ["Abu", "abu.PNG", "4829Q"],
      ["Cowboy", "cowboy.PNG", "5921X"],
      ["Love", "farah2.PNG", "9031D"],
      ["Sword of Allah", "swordofallah.jpg", "7832K"],
      ["The Orthodox", "theorthodox.PNG", "9205Y"],
      ["Salaam Alaykum", "salaamalaykum.PNG", "9205M"],
      ["ILYES", "", "920TT"],
      ["Libra", "libra.PNG", "9205T"]
    ];
    profileview.innerHTML = profiles_views.map(([name, img]) => `
      <div class="profilecolumn" data-name="${name}">
        <div class="profileimg">
          <img src="./images/${img}" alt="${name}">
        </div>
        <div class="username_container"><p>${name}</p></div>
      </div>
    `).join("");

    /* Menu show/hide */
    function openMenu(){ menuEl.classList.add('is-open'); menuEl.setAttribute('aria-hidden','false'); }
    function closeMenu(){ menuEl.classList.remove('is-open'); menuEl.setAttribute('aria-hidden','true'); }
    menuOpen.addEventListener('click', openMenu);
    menuClose.addEventListener('click', closeMenu);
    menuEl.addEventListener('click', (e) => { if (e.target === menuEl) closeMenu(); });

    /* Auth */
    let currentUser = null;

    function setFormEnabled(enabled){
      chatInput.disabled = !enabled;
      sendBtn.disabled   = !enabled;
      chatInput.placeholder = enabled ? "Type message…" : "Messaging disabled";
    }

    function applyUser(u){
      if (!u){
        currentUser = null;
        setFormEnabled(false);
        userBadge.hidden = true;
        badgeName.textContent = '';
        avatarEl.src = '';
        sessionStorage.removeItem('dl_user');
        return;
      }
      currentUser = u;
      setFormEnabled(true);
      userBadge.hidden = false;
      badgeName.textContent = u.name;
      avatarEl.src = `./images/${u.img}`;
      avatarEl.alt = u.name;
      sessionStorage.setItem('dl_user', JSON.stringify(u));
    }

    loginBtn.addEventListener('click', () => {
      const name = (loginUser.value || '').trim();
      const code = (loginCode.value || '').trim();
      const match = profiles_users.find(([n,_img,c]) => n === name && c === code);
      if (!match){ alert('Invalid username or code.'); return; }
      const [n, img, c] = match;
      applyUser({ name:n, img, code:c });
      closeMenu();
      setTimeout(() => chatInput.focus(), 50);
    });

    /* Auto-login from URL, if valid */
    (function autoLoginFromURL(){
      const params = new URLSearchParams(location.search);
      const refUser = params.get("refusrname");
      const refPass = params.get("refpassword");
      if (!refUser || !refPass) return;
      const m = profiles_users.find(([n,_i,c]) => n === refUser && c === refPass);
      if (m){
        const [n, img, c] = m;
        applyUser({ name:n, img, code:c });
      } else {
        // just prefill if not valid
        loginUser.value = refUser;
        loginCode.value = refPass;
      }
    })();

    /* Feed layout helpers */
    function syncFeedPadding(){
      const h = composer.offsetHeight || 0;
      messagesEl.style.paddingBottom = (h + 20) + 'px'; // 20px margin below
    }
    function scrollToBottom(smooth){
      requestAnimationFrame(() => {
        messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
      });
    }
    syncFeedPadding();
    window.addEventListener('resize', syncFeedPadding);
    if (window.visualViewport){
      visualViewport.addEventListener('resize', syncFeedPadding);
      visualViewport.addEventListener('scroll',  syncFeedPadding);
    }
    chatInput.addEventListener('focus', syncFeedPadding);
    chatInput.addEventListener('blur',  syncFeedPadding);

    /* Firestore (chat) */
    const messagesRef = collection(db, 'messages');
    const q = query(messagesRef, orderBy('createdAt','asc'), limit(50));
    onSnapshot(q, (snap) => {
      messagesEl.innerHTML = '';
      snap.forEach(doc => {
        const m = doc.data();
        const name = m.username || '';
        const chat = m.chat || '';
        const img = avatarByName.get(name) || 'default-avatar.png';

        const row   = document.createElement('div'); row.className = 'msg';
        const av    = document.createElement('img'); av.className = 'avatar'; av.src = `./images/${img}`; av.alt = name || 'avatar';
        const bubble= document.createElement('div'); bubble.className = 'bubble';
        const nm    = document.createElement('div'); nm.className = 'name'; nm.textContent = name;
        const body  = document.createElement('div'); body.textContent = chat;

        bubble.appendChild(nm);
        bubble.appendChild(body);
        row.appendChild(av);
        row.appendChild(bubble);
        messagesEl.appendChild(row);
      });
      syncFeedPadding();
      scrollToBottom();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser){ alert('❌ Please log in first from Menu.'); return; }
      const chat = (chatInput.value || '').trim();
      if (!chat) return;
      await addDoc(messagesRef, { username: currentUser.name, chat, createdAt: serverTimestamp() });
      chatInput.value = '';
      chatInput.focus();
      syncFeedPadding();
      scrollToBottom(true);
    });

    /* Push (manual) */
    const SW_PATH   = '/Dawah-Lumen/firebase-messaging-sw.js?v=3';
    const VAPID_KEY = 'BNUEVOAAfOuD3NrU9PgnZMWXL42hZqsrSCJqMZUNJtC2cx840YvnSdEFzJEL58-J6p02IHaj3eOe6y-bSCr48XY';
    enablePushBtn.addEventListener('click', async () => {
      try{
        const supported = await isSupported();
        if (!supported){ permStatus.textContent = 'Push not supported in this browser.'; return; }
        if (!('serviceWorker' in navigator)){ permStatus.textContent = 'No Service Worker support.'; return; }
        const reg = await navigator.serviceWorker.register(SW_PATH);
        let permission = Notification.permission;
        if (permission !== 'granted') permission = await Notification.requestPermission();
        permStatus.textContent = `Permission: ${permission}`;
        if (permission !== 'granted') return;

        const messaging = getMessaging(app);
        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
        if (token){
          await addDoc(collection(db, 'tokens'), { token, createdAt: serverTimestamp() });
          permStatus.textContent = 'Notifications enabled.';
        }else{
          permStatus.textContent = 'Failed to get token.';
        }
        onMessage(messaging, (payload) => {
          if (Notification.permission === 'granted'){
            new Notification(payload?.notification?.title || 'New message', { body: payload?.notification?.body || '' });
          }
        });
      }catch(err){
        console.error(err);
        permStatus.textContent = 'Error enabling notifications.';
      }
    });

    /* Profiles: tap → insert @Username into chat input */
    profileview.addEventListener('click', (e) => {
      const card = e.target.closest('.profilecolumn');
      if (!card) return;
      const name = card.getAttribute('data-name') || card.querySelector('.username_container p')?.textContent || '';
      if (!name) return;
      const pre = chatInput.value ? chatInput.value.replace(/\s+$/,'') + ' ' : '';
      chatInput.value = '@' + name + ' ';
      chatInput.focus();
      scrollToBottom(true);
    });
  </script>
</body>
</html>
