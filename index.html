<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dawah Luminance</title>

  <!-- Viewport / iOS-safe layout -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <meta name="apple-mobile-web-app-title" content="Dawah Luminance">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Theme color -->
  <meta name="theme-color" content="#001d4b">

  <!-- Icons & Web Manifest (paths for GitHub Pages project site) -->
  <link rel="apple-touch-icon" sizes="192x192" href="/Dawah-Lumen/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/Dawah-Lumen/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/Dawah-Lumen/icons/icon-512.png">
  <link rel="manifest" href="/Dawah-Lumen/manifest.webmanifest">

  <!-- Your styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Tiny inline styles just for Menu panel (keep the rest in style.css) -->
  <style>
    .topbar { max-width:760px; width:100%; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .menu-btn { appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.2); color:#fff; padding:.45rem .7rem; border-radius:.5rem; }
    .menu-panel {
      position: fixed; inset: auto 0 0 0; transform: translateY(105%);
      background: rgba(0,0,0,.85); backdrop-filter: blur(6px);
      border-top: 1px solid rgba(255,255,255,.1);
      color:#fff; padding: 1rem; transition: transform .25s ease;
    }
    .menu-panel.show { transform: translateY(0); }
    .menu-grid { display:flex; flex-direction:column; gap:.8rem; max-width:760px; margin: 0 auto; }
    .menu-row { display:flex; gap:.5rem; align-items:center; }
    .menu-row input { flex: 1 1 auto; min-width:0; padding:.55rem .6rem; border-radius:.5rem; border:none; outline:none; }
    .menu-actions { display:flex; gap:.5rem; flex-wrap:wrap; }
    .close-btn { margin-left:auto; appearance:none; border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.2); color:#fff; padding:.45rem .7rem; border-radius:.5rem; }
    #debugToggleRow { display:flex; align-items:center; gap:.5rem; }
    #debugBox { display:none; max-height:30vh; overflow:auto; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.15); border-radius:.5rem; padding:.6rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; }
    #debugBox.show { display:block; }
    .debug-tag { opacity:.7; margin-right:.4rem; }
  </style>
</head>
<body id="body">
  <h1>Dawah Luminance 💡 PWA simple update guest</h1>
  <div class="hint">One room. Text only.</div>

  <div class="topbar">
    <div class="userBadge" id="userBadge" hidden>
      <img id="avatar" class="avatar" alt="avatar" src="">
      <span id="badgeName"></span>
    </div>
    <button id="menuBtn" class="menu-btn" type="button">☰ Menu</button>
  </div>

  <div id="messages">Loading…</div>
  <div id="buffer" style="margin-top:32px;opacity:0;">Loading</div>

  <div class="formsend">
    <form id="form" class="row">
      <input id="chat" type="text" placeholder="Messaging disabled" maxlength="500" disabled>
      <button id="sendBtn" type="submit" disabled></button>
    </form>
  </div>

  <!-- Slide-up Menu -->
  <div id="menuPanel" class="menu-panel" aria-hidden="true">
    <div class="menu-grid">
      <div class="menu-row" style="justify-content:space-between;">
        <strong>Menu</strong>
        <button id="menuClose" class="close-btn" type="button">Close ✕</button>
      </div>

      <!-- Simple note (replaces the old iOS banner) -->
      <p style="opacity:.9;margin:.25rem 0 .5rem;">
        Add to Home Screen and allow push notifications.
      </p>

      <!-- Login -->
      <div><strong>Login</strong></div>
      <div class="menu-row">
        <input id="loginUser" value="Guest" placeholder='Username e.g. "Guest"'>
        <input id="loginCode" value="12345" placeholder='Code e.g. "12345"'>
        <button id="loginBtn" class="menu-btn" type="button">Login</button>
      </div>

      <!-- Notifications -->
      <div><strong>Notifications</strong></div>
      <div class="menu-actions">
        <button id="enablePush" class="menu-btn" type="button">Enable notifications</button>
        <span id="permStatus" class="tiny"></span>
      </div>

      <!-- Debug -->
      <div id="debugToggleRow">
        <input id="debugToggle" type="checkbox">
        <label for="debugToggle">Show debug box</label>
      </div>
      <div id="debugBox" aria-live="polite"></div>

      <!-- Warnings -->
      <div id="warn" class="warn"></div>
    </div>
  </div>

  <script type="module">
    // Firebase (CDN, modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import {
      getMessaging, getToken, onMessage, isSupported
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";

    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDOZU1AJi7ONWlKYgiIJXWoj7X8VAoZ9rM",
      authDomain: "dawah-lumen-v1.firebaseapp.com",
      projectId: "dawah-lumen-v1",
      storageBucket: "dawah-lumen-v1.firebasestorage.app",
      messagingSenderId: "796313906776",
      appId: "1:796313906776:web:045884e106cf4ee5f2e42d",
      measurementId: "G-660003ER5V"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Elements
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('form');
    const chatInput = document.getElementById('chat');
    const sendBtn = document.getElementById('sendBtn');
    const warnEl = document.getElementById('warn');
    const userBadge = document.getElementById('userBadge');
    const avatarEl = document.getElementById('avatar');
    const badgeName = document.getElementById('badgeName');

    const menuBtn = document.getElementById('menuBtn');
    const menuClose = document.getElementById('menuClose');
    const menuPanel = document.getElementById('menuPanel');

    const loginUser = document.getElementById('loginUser');
    const loginCode = document.getElementById('loginCode');
    const loginBtn  = document.getElementById('loginBtn');

    const enablePushBtn = document.getElementById('enablePush');
    const permStatus = document.getElementById('permStatus');

    const debugToggle = document.getElementById('debugToggle');
    const debugBox = document.getElementById('debugBox');

    // Profiles (includes Guest)
    const profiles_users = [
      ["Guest", "picture.png", "12345"],
      ["Abu", "abu.PNG", "4829Q"],
      ["Chaos", "chaos.PNG", "1937A"],
      ["Cowbow", "cowboy.PNG", "5921X"],
      ["Da Kid", "dakid.jpg", "7704B"],
      ["Draco", "draco.PNG", "8382Z"],
      ["Empress", "empress.jpg", "2229C"],
      ["Love", "farah.PNG", "9031D"],
      ["Abdul Jaleel", "gmoney.webp", "5167E"],
      ["Hakeem", "hakeem.avif", "1473F"],
      ["Lut", "lut.PNG", "3345G"],
      ["Mr Khan", "mrkhan.PNG", "4402H"],
      ["Premier", "premeir.jpg", "6619J"],
      ["Sword of Allah", "swordofallah.jpg", "7832K"],
      ["The Lion", "thelion.PNG", "1984L"],
      ["Whiskey Blues", "whiskeybluews.PNG", "9203M"],
      ["safwan", "safwan.PNG", "9204M"],
      ["Salaam Alaykum", "salaamalaykum.PNG", "9205M"],
      ["Guest", "picture.png", "12345"],
    ];
    const avatarByName = new Map(profiles_users.map(([n, img]) => [n, img]));

    // --- Logger (to debug box) ---
    function log(line, tag='log'){
      if (!debugBox) return;
      const stamp = new Date().toLocaleTimeString();
      const el = document.createElement('div');
      el.innerHTML = `<span class="debug-tag">[${stamp}] ${tag.toUpperCase()}:</span> ${line}`;
      debugBox.appendChild(el);
      debugBox.scrollTop = debugBox.scrollHeight;
      console[tag === 'error' ? 'error' : 'log'](`[${tag}]`, line);
    }

    // Menu show/hide
    menuBtn.addEventListener('click', () => { menuPanel.classList.add('show'); menuPanel.setAttribute('aria-hidden','false'); });
    menuClose.addEventListener('click', () => { menuPanel.classList.remove('show'); menuPanel.setAttribute('aria-hidden','true'); });

    debugToggle.addEventListener('change', () => {
      if (debugToggle.checked) debugBox.classList.add('show');
      else debugBox.classList.remove('show');
    });

    // Auth state
    let currentUser = null;

    function setFormEnabled(enabled){
      chatInput.disabled = !enabled;
      sendBtn.disabled = !enabled;
      chatInput.placeholder = enabled ? "Type message…" : "Messaging disabled";
    }

    function applyUser(u){
      if (!u){
        currentUser = null;
        setFormEnabled(false);
        userBadge.hidden = true;
        badgeName.textContent = '';
        avatarEl.src = '';
        sessionStorage.removeItem('dl_user');
        return;
      }
      currentUser = u;
      setFormEnabled(true);
      userBadge.hidden = false;
      badgeName.textContent = u.name;
      avatarEl.src = `./images/${u.img}`;
      avatarEl.alt = u.name;
      sessionStorage.setItem('dl_user', JSON.stringify(u));
      log(`Logged in as ${u.name}`, 'info');
    }

    // Login
    loginBtn.addEventListener('click', () => {
      const name = (loginUser.value || '').trim();
      const code = (loginCode.value || '').trim();
      const match = profiles_users.find(([n,_img,c]) => n === name && c === code);
      if (!match){
        warnEl.textContent = 'Invalid username or code.';
        log('Invalid login attempt', 'warn');
        return;
      }
      const [n, img, c] = match;
      warnEl.textContent = '';
      applyUser({ name:n, img, code:c });
    });

    // Restore user from session (optional)
    const saved = sessionStorage.getItem('dl_user');
    if (saved){
      try{
        const u = JSON.parse(saved);
        const stillValid = profiles_users.some(([n,_i,c]) => n===u.name && c===u.code);
        if (stillValid) applyUser(u);
      }catch{}
    }

    // -------- Firestore (chat) --------
    const messagesRef = collection(db, 'messages');
    const q = query(messagesRef, orderBy('createdAt','asc'), limit(50));
    onSnapshot(q, (snap) => {
      messagesEl.innerHTML = '';
      snap.forEach(doc => {
        const m = doc.data();
        const name = m.username || '';
        const chat = m.chat || '';
        const img = avatarByName.get(name) || 'default-avatar.png';

        const row = document.createElement('div'); row.className = 'msg';
        const av  = document.createElement('img'); av.className = 'avatar'; av.src = `./images/${img}`; av.alt = name || 'avatar';
        const bubble = document.createElement('div'); bubble.className = 'bubble';
        const nm = document.createElement('div'); nm.className = 'name'; nm.textContent = name;
        const body = document.createElement('div'); body.textContent = chat;

        bubble.append(nm, body);
        row.append(av, bubble);
        messagesEl.appendChild(row);
      });
      requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight; });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { alert('❌ Please log in first from Menu.'); return; }
      const chat = (chatInput.value || '').trim();
      if (!chat) return;
      await addDoc(messagesRef, { username: currentUser.name, chat, createdAt: serverTimestamp() });
      chatInput.value = '';
      chatInput.focus();
      requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight; });
    });

    chatInput.addEventListener('focus', () => requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight; }));
    chatInput.addEventListener('blur',  () => requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight; }));

    // -------- Web Push (user must click the button) --------
    const SW_PATH   = '/Dawah-Lumen/firebase-messaging-sw.js?v=3';
    const VAPID_KEY = 'BNUEVOAAfOuD3NrU9PgnZMWXL42hZqsrSCJqMZUNJtC2cx840YvnSdEFzJEL58-J6p02IHaj3eOe6y-bSCr48XY';

    enablePushBtn.addEventListener('click', async () => {
      try{
        const supported = await isSupported();
        if (!supported) { permStatus.textContent = 'Push not supported in this browser.'; log('Push not supported', 'warn'); return; }
        if (!('serviceWorker' in navigator)) { permStatus.textContent = 'Service workers not supported.'; log('No serviceWorker', 'warn'); return; }

        const reg = await navigator.serviceWorker.register(SW_PATH);
        log('Service worker registered', 'info');

        let permission = Notification.permission;
        if (permission !== 'granted') permission = await Notification.requestPermission();
        permStatus.textContent = `Permission: ${permission}`;
        if (permission !== 'granted') { log('Permission not granted', 'warn'); return; }

        const messaging = getMessaging(app);
        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
        if (token) {
          await addDoc(collection(db, 'tokens'), { token, createdAt: serverTimestamp() });
          permStatus.innerHTML = '<span class="ok">Notifications enabled.</span>';
          log('Token saved to Firestore', 'info');
        } else {
          permStatus.textContent = 'Failed to get token.';
          log('Failed to get token', 'error');
        }

        onMessage(messaging, (payload) => {
          log('Foreground message received', 'info');
          if (Notification.permission === 'granted') {
            new Notification(payload?.notification?.title || 'New message', { body: payload?.notification?.body || '' });
          }
        });
      }catch(err){
        console.error(err);
        permStatus.textContent = 'Error enabling notifications. See console.';
        log('Enable push error: ' + (err?.message || err), 'error');
      }
    });

    // Small debug
    document.addEventListener('visibilitychange', () => {
      log('visibility: ' + document.visibilityState, 'info');
    });
  </script>
</body>
</html>
