<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dawah Luminance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body {max-width: 720px;margin: 2rem auto;padding: 0 1rem;}
    h1 { margin-bottom: .25rem; }
    .hint { color:#666; margin-bottom: 1rem; }

    #messages {display: flex;flex-direction: column;gap: 0.4rem;margin: 2.5rem 0px;x;}

    .msg {
    display:flex;
    align-items: flex-start;
    gap: 0.6rem;
    padding: 1.3rem .8rem;
    border: 18px solid #ddd;
    border-radius:.6rem;
    border: 2.4px solid;
    /* border-top-color: rgb(251 77 117);
    border-right-color: #1cdd1c;
    border-bottom-color: #2ca0e3;
    border-left-color: #fff700; */
    }
    .msg .bubble { flex: 1; }
    .msg .name {font-weight:600;margin-bottom:.15rem;font-size: large;}
    .avatar {width: 36px;height: 36px;border-radius: 50%;object-fit: cover;border: 1px solid #ddd;}

    .row {display: flex;gap: -5.5rem;flex-wrap: wrap;align-items: center;/* display: none; */}
    input[type="text"] { padding: .6rem .7rem; }
    #chat { flex: 1; min-width: 220px; }
    button { padding: .6rem .9rem; cursor: pointer; }

    .warn { color: #b00020; margin-top: .25rem; }
    .ok { color: #0a7a0a; }
    .tiny {font-size: .85rem;color:#666;display: none;}
    code {background:#f6f6f6;padding: .1rem .3rem;border-radius: .25rem;display: none;}
    .userBadge { display:flex; align-items:center; gap:.5rem; margin:.5rem 0 1rem; color:#888; }
    .banner { display:none; background:#f6fbff; border:1px solid #cde9ff; padding:.6rem .8rem; border-radius:.5rem; margin:.75rem 0; }
    .banner.show { display:block; }
  </style>
</head>
<body id="body">
  <h1>Dawah Luminance üí°</h1>
  <div class="hint">One room. Text only. Username is chosen from the link (URL).</div>

  <div id="debugform" class="row">
    <label>Username:
      <input id="username" placeholder="(from URL)" />
    </label>
    <div class="userBadge" id="userBadge" hidden>
      <img id="avatar" class="avatar" alt="avatar" src="" />
      <span id="badgeName"></span>
    </div>
    <button id="enablePush" type="button">Enable notifications</button>
  </div>

  <!-- Auto-enable banner (shown if refnotification=set needs a gesture) -->
  <div id="notifBanner" class="banner">
    Click to finish enabling notifications for this device:
    <button id="enablePushInline" type="button">Enable now</button>
  </div>

  <div id="permStatus" class="tiny"></div>
  <div id="warn" class="warn"></div>

  <div id="messages">Loading‚Ä¶</div>

  <form id="form" class="row">
    <input id="chat" type="text" placeholder="Type message‚Ä¶" maxlength="500" />
    <button type="submit">Send</button>
  </form>

  <div class="tiny">
    Debug: SW path <code id="swPathOut"></code> ¬∑
    Permission <code id="permOut"></code> ¬∑
    Token (first 12) <code id="tokOut"></code>
  </div>

  <div class="margin">


  </div>

  <script type="module">
    // Firebase (CDN, modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import {
      getMessaging, getToken, onMessage, isSupported
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";

    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDOZU1AJi7ONWlKYgiIJXWoj7X8VAoZ9rM",
      authDomain: "dawah-lumen-v1.firebaseapp.com",
      projectId: "dawah-lumen-v1",
      storageBucket: "dawah-lumen-v1.firebasestorage.app",
      messagingSenderId: "796313906776",
      appId: "1:796313906776:web:045884e106cf4ee5f2e42d",
      measurementId: "G-660003ER5V"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // DOM
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('form');
    const chatInput = document.getElementById('chat');
    const unameInput = document.getElementById('username');
    const warnEl = document.getElementById('warn');
    const enablePushBtn = document.getElementById('enablePush');
    const enablePushInlineBtn = document.getElementById('enablePushInline');
    const permStatus = document.getElementById('permStatus');
    const notifBanner = document.getElementById('notifBanner');

    const swPathOut = document.getElementById('swPathOut');
    const permOut = document.getElementById('permOut');
    const tokOut = document.getElementById('tokOut');

    const userBadge = document.getElementById('userBadge');
    const avatarEl = document.getElementById('avatar');
    const badgeName = document.getElementById('badgeName');

    // --------------------------------------------------
    // URL-based access control (username + secret code)
    // --------------------------------------------------
    // Profiles: [username, imageFileIn/images, secretCode(4 digits + 1 letter)]
    const profiles_users = [
      ["Abu", "abu.PNG", "4829Q"],
      ["Chaos", "chaos.PNG", "1937A"],
      ["Cowbow", "cowboy.PNG", "5921X"],
      ["Da Kid", "dakid.jpg", "7704B"],
      ["Draco", "draco.PNG", "8382Z"],
      ["Empress", "empress.jpg", "2229C"],
      ["Love", "farah.PNG", "9031D"],
      ["Abdul Jaleel", "gmoney.webp", "5167E"],
      ["Hakeem", "hakeem.avif", "1473F"],
      ["Lut", "lut.PNG", "3345G"],
      ["Mr Khan", "mrkhan.PNG", "4402H"],
      ["Premier", "premeir.jpg", "6619J"],
      ["Sword of Allah", "swordofallah.jpg", "7832K"],
      ["The Lion", "thelion.PNG", "1984L"],
      ["Whiskey Blues", "whiskeybluews.PNG", "9203M"]
    ];
    // Quick map for avatar lookup by name
    const avatarByName = new Map(profiles_users.map(([n, img]) => [n, img]));

    const params = new URLSearchParams(window.location.search);
    const urlusername = (params.get("refusrname") || "").trim();
    const refpassword = (params.get("refpassword") || "").trim();
    const refnotification = (params.get("refnotification") || "").trim().toLowerCase();

    let currentUser = null; // { name, img, code }
    for (let i = 0; i < profiles_users.length; i++) {
      const [name, img, code] = profiles_users[i];
      if (name === urlusername && code === refpassword) {
        currentUser = { name, img, code };
        break;
      }
    }

    if (!currentUser) {
      console.warn('[auth] URL did not match any profile', { urlusername, refpassword });
      warnEl.textContent = 'Invalid link details. You cannot send messages.';
      form.style.display = 'none';
      unameInput.value = '(invalid)';
      unameInput.readOnly = true;
    } else {
      console.log('[auth] Authenticated as:', currentUser.name);
      unameInput.value = currentUser.name;
      unameInput.readOnly = true;
      // show avatar badge
      avatarEl.src = `./images/${currentUser.img}`;
      avatarEl.alt = currentUser.name;
      badgeName.textContent = currentUser.name;
      userBadge.hidden = false;
    }

    // -------------------
    // Firestore data model
    // -------------------
    const messagesRef = collection(db, 'messages');

    // Live view (latest 50) with avatar
    const q = query(messagesRef, orderBy('createdAt','asc'), limit(50));
    onSnapshot(q, (snap) => {
      console.debug('[chat] snapshot size', snap.size);
      messagesEl.innerHTML = '';
      snap.forEach(doc => {
        const m = doc.data();
        const name = m.username || '';
        const chat = m.chat || '';
        const img = avatarByName.get(name) || 'default-avatar.png'; // put a default in /images if you want
        const row = document.createElement('div');
        row.className = 'msg';
        const av = document.createElement('img');
        av.className = 'avatar';
        av.src = `./images/${img}`;
        av.alt = name || 'avatar';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const nm = document.createElement('div');
        nm.className = 'name';
        nm.textContent = name;
        const body = document.createElement('div');
        body.innerHTML = escapeHtml(chat);
        bubble.appendChild(nm);
        bubble.appendChild(body);
        row.appendChild(av);
        row.appendChild(bubble);
        messagesEl.appendChild(row);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // Send message (only if authenticated by URL)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      warnEl.textContent = '';
      if (!currentUser) {
        alert('‚ùå Please enter the correct details in the link.');
        return;
      }
      const chat = (chatInput.value || '').trim();
      if (!chat) return;
      console.debug('[chat] sending', { username: currentUser.name, chat });
      await addDoc(messagesRef, {
        username: currentUser.name,
        chat,
        createdAt: serverTimestamp()
      });
      chatInput.value = '';
      chatInput.focus();
    });

    // -----------------------
    // Push setup + debugging
    // -----------------------
    const SW_PATH = '/Dawah-Lumen/firebase-messaging-sw.js?v=3'; // cache-bust
    const VAPID_KEY = 'BNUEVOAAfOuD3NrU9PgnZMWXL42hZqsrSCJqMZUNJtC2cx840YvnSdEFzJEL58-J6p02IHaj3eOe6y-bSCr48XY';
    swPathOut.textContent = SW_PATH;

    async function enablePushFlow() {
      try {
        const supported = await isSupported();
        console.debug('[push] isSupported', supported);
        if (!supported) {
          permStatus.textContent = 'Push not supported in this browser.';
          return;
        }
        if (!('serviceWorker' in navigator)) {
          permStatus.textContent = 'Service workers not supported.';
          return;
        }

        console.debug('[sw] registering', SW_PATH);
        const reg = await navigator.serviceWorker.register(SW_PATH);
        console.debug('[sw] state', reg.installing?.state, reg.active?.state);

        // Some browsers require a user gesture for requestPermission; this may throw if called silently.
        const permission = await Notification.requestPermission();
        permOut.textContent = permission;
        permStatus.textContent = `Permission: ${permission}`;
        console.debug('[push] permission', permission);
        if (permission !== 'granted') {
          // Surface the inline banner for a manual click if auto attempt failed.
          notifBanner.classList.add('show');
          return;
        }

        // Get FCM token
        const messaging = getMessaging(app);
        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
        console.debug('[push] token', token);
        tokOut.textContent = token ? token.slice(0, 12) : '';
        if (token) {
          await addDoc(collection(db, 'tokens'), { token, createdAt: serverTimestamp() });
          permStatus.innerHTML = '<span class="ok">Notifications enabled.</span>';
          notifBanner.classList.remove('show');
        } else {
          permStatus.textContent = 'Failed to get token.';
          notifBanner.classList.add('show');
        }

        // Foreground messages (tab focused)
        onMessage(messaging, (payload) => {
          console.debug('[push] onMessage (foreground)', payload);
          if (Notification.permission === 'granted') {
            new Notification(payload.notification?.title || 'New message', {
              body: payload.notification?.body || ''
            });
          }
        });
      } catch (err) {
        console.error('[push] enable error', err);
        permStatus.textContent = 'Error enabling notifications. See console.';
        // Show banner to let user retry with a click
        notifBanner.classList.add('show');
      }
    }

    // Button + inline banner both run the same flow
    enablePushBtn.addEventListener('click', enablePushFlow);
    enablePushInlineBtn.addEventListener('click', enablePushFlow);

    // If URL asks for notifications, try automatically; if browser blocks,
    // the banner will appear to finish with one click.
    if (refnotification === 'set') {
      enablePushFlow();
    }

    // helper
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    // Quick visibility log to know if tab is backgrounded
    document.addEventListener('visibilitychange', () => {
      console.debug('[page] visibility', document.visibilityState);
    });
  </script>
</body>
</html>
